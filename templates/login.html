<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="initial-scale=1, width=device-width" />

    <!-- http://getbootstrap.com/docs/5.1/ -->
    <link
      crossorigin="anonymous"
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN"
      rel="stylesheet"
    />

    <!-- Font -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@200;400;500;600;700;900&display=swap"
      rel="stylesheet"
    />

    <!-- Ajax -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>

    <script
      src="https://kit.fontawesome.com/eb060ea3b1.js"
      crossorigin="anonymous"
    ></script>
    <script
      crossorigin="anonymous"
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL"
    ></script>

    <link href="/static/styles.css" rel="stylesheet" />

    <link rel="icon" href="./static/images/favicon.ico" />
    <title>Log in â€“ Pest Advisor</title>
  </head>

  <body>
    <div class="d-flex flex-column" style="height: 100%; width: 100%">
      <div class="d-flex my-5 justify-content-center">
        <img
          src="./static/images/logo.png"
          style="max-height: 150px; max-width: 150px"
        />
      </div>
      <div class="d-flex flex-column mx-3 mb-4 align-items-center">
        <div class="card p-4 rounded-5 shadow" style="max-width: 400px">
          <form id="login-form">
            <div class="mb-3">
              <label for="loginEmail" class="form-label">Email address</label>
              <input
                type="email"
                class="form-control border-2"
                id="loginEmail"
                autocomplete="on"
                value=""
                required
              />
              {% if error %}
              <div class="form-text" style="color: red">{{ error }}</div>
              {% endif %}
            </div>
            <div class="mb-3">
              <label for="loginPassword" class="form-label">Password</label>
              <input
                type="password"
                class="form-control border-2"
                id="loginPassword"
                required
              />
            </div>
            <div class="mb-3 form-check">
              <input
                type="checkbox"
                class="form-check-input"
                id="seePassword"
              />
              <label class="form-check-label" for="seePassword"
                >See Password</label
              >
            </div>
            <input type="hidden" name="form" value="first" />
            <button
              type="submit"
              class="btn btn-primary"
              id="form-login"
              name="form-login"
              value="Log in form"
              style="width: 100%; background: #007837"
            >
              <strong>Log In</strong>
            </button>
            <p
              class="text-center m-0"
              id="error-message-card"
              style="color: red; font-size: 0.9rem"
            ></p>
          </form>
        </div>
      </div>
      <div class="d-flex flex-column mx-3 mb-3 align-items-center">
        <div class="card px-4 py-3 rounded-4 shadow" style="max-width: 400px">
          <p class="m-0">
            Don't have an account?
            <a
              class="btn p-0"
              data-bs-toggle="modal"
              data-bs-target="#signUp"
              style="color: #2061db"
            >
              <strong>Sign up</strong>
            </a>
          </p>
        </div>
      </div>
      <div class="modal fade" id="signUp" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content">
            <div class="modal-header">
              <h1 class="modal-title fs-5" id="exampleModalLabel">Sign Up</h1>
              <button
                type="button"
                class="btn-close"
                data-bs-dismiss="modal"
                aria-label="Close"
              ></button>
            </div>
            <div class="modal-body">
              <div class="d-flex flex-column" style="height: 100%; width: 100%">
                <div class="d-flex flex-column mx-3 mb-4 align-items-center">
                  <form id="signup-form">
                    <div class="mb-3">
                      <label for="username" class="form-label">Username</label>
                      <input
                        class="form-control border-2"
                        id="username"
                        autocomplete="on"
                        required
                      />
                    </div>
                    <div class="mb-3">
                      <label for="signupEmail" class="form-label"
                        >Email address</label
                      >
                      <input
                        type="email"
                        class="form-control border-2"
                        id="signupEmail"
                        autocomplete="on"
                        required
                      />
                    </div>
                    <div class="mb-3">
                      <label for="signupPassword" class="form-label"
                        >Password</label
                      >
                      <input
                        type="password"
                        class="form-control border-2"
                        id="signupPassword"
                        required
                      />
                    </div>
                    <div class="mb-3">
                      <label for="repeatPassword" class="form-label"
                        >Confirm Password</label
                      >
                      <input
                        type="password"
                        class="form-control border-2"
                        id="repeatPassword"
                        required
                      />
                    </div>
                    <input type="hidden" name="form" value="second" />
                    <button
                      type="submit"
                      class="btn btn-primary mt-3"
                      id="form-signup"
                      name="form-signup"
                      value="Sign up form"
                      style="width: 100%; background: #007837"
                    >
                      <strong>Sign up</strong>
                    </button>
                    <p
                      class="text-center m-0"
                      id="error-message"
                      style="color: red; font-size: 0.9rem"
                    ></p>
                  </form>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      function showErrorInCard(errorMessage) {
        $("#error-message-card").text(errorMessage);
      }

      $("#login-form").on("submit", function (event) {
        event.preventDefault();
        var email = $("#loginEmail").val();
        var password = $("#loginPassword").val();
        var form = "first";

        // Make an AJAX request to check if the username is taken
        $.ajax({
          url: "/check_signup", // Your Flask route for checking the username
          method: "POST",
          data: { email: email, password: password, form: form },
          success: function (response) {
            if (response.wrong_email) {
              showErrorInCard("Email or Password was incorrect!");
            } else if (response.wrong_password) {
              showErrorInCard("Email or Password was incorrect!");
            } else {
              window.location.href = "/";
            }
          },
        });
      });

      // Function to show the error message in the modal
      function showErrorInModal(errorMessage) {
        // Update the error message inside the modal
        $("#error-message").text(errorMessage);
        // Open the modal if it's not already open
        $("#signUp").modal("show");
      }

      // In your Flask route, use AJAX to check if the username is taken and call showErrorInModal if it is
      $("#signup-form").on("submit", function (event) {
        event.preventDefault();
        var username = $("#username").val(); // Get the username from the form
        var email = $("#signupEmail").val();
        var password = $("#signupPassword").val();
        var repeatPassword = $("#repeatPassword").val();
        var form = "second";

        // Make an AJAX request to check if the username is taken
        $.ajax({
          url: "/", // Your Flask route for checking the username
          method: "POST",
          data: {
            username: username,
            email: email,
            password: password,
            repeatPassword: repeatPassword,
            form: form,
          },
          success: function (response) {
            if (response.username_taken) {
              showErrorInModal("Username already exist!");
            } else if (response.email_taken) {
              showErrorInModal("Email is already in use!");
            } else if (response.password_different) {
              showErrorInModal("Passwords do not match!");
            } else {
              window.location.href = "/";
            }
          },
        });
      });
    </script>
  </body>
</html>
